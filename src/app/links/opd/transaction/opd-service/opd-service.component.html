<app-navbar />

<form #myForm="ngForm" class="mt-4 mx-auto">
  <div class="w-full flex flex-wrap">
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
      <app-date [value]="opdService.date" [title]="'Date'" [name]="'date'" [placeHolder]="'DD-MMM-YYYY'"
        [required]="true"></app-date>
    </div>
  </div>
  <div class="w-full flex flex-wrap">
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.uhid" [value]="opdService.uhid" [name]="'uhid'" [type]="'text'"
        [placeHolder]="'UHID'" [title]="'Uhid'" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.opid" [value]="opdService.opid" [name]="'opid'" [type]="'text'"
        [placeHolder]="'OPID'" [title]="'OPID'" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.receiptNo" [value]="opdService.receiptNo" [name]="'receiptNo'"
        [type]="'text'" [placeHolder]="'Receipt No'" [title]="'Receipt No'" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.patientName" [value]="opdService.patientName" [name]="'patientName'"
        [type]="'text'" [placeHolder]="'Patient Name'" [title]="'Patient Name'" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.age" [value]="opdService.age" [name]="'age'" [type]="'text'"
        [placeHolder]="'Age'" [title]="'Age'" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-drop-down [(ngModel)]="opdService.departmentId" [value]="opdService.departmentId" [disabled]="true"
        [name]="'department'" [title]="'Department'" [list]="departmentsList"></app-drop-down>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-drop-down [(ngModel)]="opdService.companyId" [value]="opdService.companyId" [list]="companiesList"
        [disabled]="true" [name]="'company'" [title]="'Company'"></app-drop-down>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-text-field [(ngModel)]="opdService.type" [value]="opdService.type" [name]="'type'" [type]="'text'"
        [placeHolder]="'Type'" [title]="'Type'" [highlight]="true" [disabled]="true"></app-text-field>
    </div>
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
      <app-drop-down [(ngModel)]="opdService.doctorId" [value]="opdService.doctorId" [list]="doctorsList"
        [disabled]="true" [name]="'doctor'" [title]="'Doctor'"></app-drop-down>
    </div>
  </div>
</form>
<mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" [selectedIndex]="2"
  (selectedTabChange)="tabChanged($event)">
  <mat-tab [disabled]="patientDetailsLoaded === false" label="Charge">
    <div class="mt-4">
      <div class="w-full flex flex-wrap">
        <!-- Services -->
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" [htmlFor]="'service'">
            {{'Service'}}&nbsp;<span class="text-red-900">*</span>
          </label>
          <select
            class="appearance-none block w-full bg-gray-200 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
            [name]="'service'" [(ngModel)]="charge.service" [value]="charge.service" (ngModelChange)="getSubService()">
            <option value="0" selected>--Select One--</option>
            <option *ngFor="let m of servicesList" [value]="m.key">{{m.value}}</option>
          </select>
        </div>
        <!-- Sub Services -->
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" [htmlFor]="'subService'">
            {{'Sub Service'}}&nbsp;<span class="text-red-900">*</span>
          </label>
          <select
            class="appearance-none block w-full bg-gray-200 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
            [name]="'subService'" [(ngModel)]="charge.subService" [value]="charge.subService">
            <option value="0" selected>--Select One--</option>
            <option *ngFor="let m of subServicesList" [value]="m.key">{{m.value}}</option>
          </select>
        </div>
        <!-- Procedure -->
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-auto-complete (focusout)="changeService()" [title]="'Procedure'" [formControl]="procedureControl"
            [placeHolder]="'Enter procedure'" [required]="true" [autoCompleteOptions]="procedureControlOptions"
            [name]="'procedure'" #procedure (valueChanged)="onProcedureChange($event)"></app-auto-complete>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-drop-down [title]="'Doctor'" [required]="true" [name]="'Doctor'" [(ngModel)]="charge.doctor"
            [value]="charge.doctor === 0 ? '' : charge.doctor" [list]="doctorsList"></app-drop-down>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-text-field [title]="'Quantity'" [type]="'number'" [required]="true" [value]="charge.quantity.toString()"
            [name]="'quantity'" [placeHolder]="'Quantity'" [(ngModel)]="charge.quantity"></app-text-field>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-text-field [title]="'Charge'" [type]="'number'" [required]="true" [value]="charge.charge.toString()"
            [(ngModel)]="charge.charge" (ngModelChange)="amountChanged()"></app-text-field>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-text-field [title]="'Discount(%)'" [type]="'number'" [value]="charge.discountPercent.toString()"
            [(ngModel)]="charge.discountPercent" (ngModelChange)="discountPercentChanged()"></app-text-field>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-text-field [title]="'Discount(Rs.)'" [type]="'number'" [value]="charge.discountRs.toString()"
            [(ngModel)]="charge.discountRs" (ngModelChange)="discountRsChanged()"></app-text-field>
        </div>
        <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 flex flex-col mt-1">
          <app-text-field [disabled]="true" [title]="'Net Charge'" [type]="'number'"
            [value]="charge.netCharge.toString()" [(ngModel)]="charge.netCharge"></app-text-field>
        </div>
      </div>
      <div class="w-full items-end flex flex-wrap justify-end -mx-3 mb-2">
        <button [disabled]="loading.adding" type="button" (click)="addClick()"
          [ngClass]="{'cursor-not-allowed':(loading.adding)}"
          class="cursor-pointer text-white bg-gray-700 hover:bg-gray-800 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-xs px-3 py-2 me-2 mb-2 dark:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">
          <span *ngIf="!loading.adding">Add</span>
          <mat-spinner *ngIf="loading.adding" [diameter]="16"></mat-spinner>
        </button>
      </div>
      @if(chargeSummaryTable.data.length > 0) {
      <div class="table-container ms-4 me-4 mb-4 ChargesSummaryTable">
        <table mat-table [dataSource]="chargeSummaryTable" class="mat-elevation-z8">
          <ng-container matColumnDef="row">
            <th mat-header-cell *matHeaderCellDef> No. </th>
            <td mat-cell *matCellDef="let element"> {{element.row}} </td>
          </ng-container>

          <ng-container matColumnDef="serviceName">
            <th mat-header-cell *matHeaderCellDef> Service Name </th>
            <td mat-cell *matCellDef="let element"> {{element.serviceName}} </td>
          </ng-container>

          <ng-container matColumnDef="subServiceName">
            <th mat-header-cell *matHeaderCellDef> Sub Service Name </th>
            <td mat-cell *matCellDef="let element"> {{element.subServiceName}} </td>
          </ng-container>

          <ng-container matColumnDef="procedureName">
            <th mat-header-cell *matHeaderCellDef> ProcedureName </th>
            <td mat-cell *matCellDef="let element"> {{element.procedureName}} </td>
          </ng-container>

          <ng-container matColumnDef="doctorName">
            <th mat-header-cell *matHeaderCellDef> Doctor Name </th>
            <td mat-cell *matCellDef="let element"> {{element.doctorName}} </td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef> Quantity </th>
            <td mat-cell *matCellDef="let element"> {{element.quantity}} </td>
          </ng-container>

          <ng-container matColumnDef="charge">
            <th mat-header-cell *matHeaderCellDef> Charge </th>
            <td mat-cell *matCellDef="let element"> {{element.charge}} </td>
          </ng-container>

          <ng-container matColumnDef="discountRs">
            <th mat-header-cell *matHeaderCellDef> Discount </th>
            <td mat-cell *matCellDef="let element"> {{element.discountRs}} </td>
          </ng-container>

          <ng-container matColumnDef="netCharge">
            <th mat-header-cell *matHeaderCellDef> Net Charge </th>
            <td mat-cell *matCellDef="let element"> {{element.netCharge}} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="chargeSummaryColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: chargeSummaryColumns;"></tr>
        </table>
      </div>
      }

      <div class="w-full flex flex-wrap">
        <div class="w-full items-end md:items-center flex flex-wrap justify-end -mx-3 mb-2">
          <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-text-field [title]="'Total Amount'" [type]="'number'" [disabled]="true"
              [value]="charge.totalAmount.toString()" [(ngModel)]="charge.totalAmount"></app-text-field>
          </div>
        </div>
        <div class="w-full items-end flex flex-wrap justify-end -mx-3 mb-2">
          <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-text-field [title]="'Total Discount'" [type]="'number'" [disabled]="true"
              [value]="charge.totalDiscount.toString()" [(ngModel)]="charge.totalDiscount"></app-text-field>
          </div>
        </div>
        <div class="w-full items-end flex flex-wrap justify-end -mx-3 mb-2">
          <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-text-field [title]="'Total Charge'" [type]="'number'" [disabled]="true"
              [value]="charge.totalCharge.toString()" [(ngModel)]="charge.totalCharge"></app-text-field>
          </div>
        </div>
        <div class="w-full items-end flex flex-wrap justify-end -mx-3 mb-2">
          <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-text-field [title]="'Paid Amount'" [type]="'number'" [value]="charge.paidAmount.toString()"
              [(ngModel)]="charge.paidAmount" (ngModelChange)="paidAmountChanged()"></app-text-field>
          </div>
        </div>
      </div>
      <div class="w-full flex flex-wrap -mx-3 mb-2">
        <div class="w-full flex items-start justify-between">
          <div class="ms-2 w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-drop-down [title]="'Referred By'" [name]="'referredBy'" [(ngModel)]="charge.referredBy"
              [value]="charge.referredBy === 0 ? '' : charge.referredBy" [list]="referredByList"></app-drop-down>
          </div>
          <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0 mt-1">
            <app-text-field [required]="true" [title]="'Remarks'" [type]="'text'" [value]="charge.remarks.toString()"
              [(ngModel)]="charge.remarks"></app-text-field>
          </div>
          <div class="w-full md:w-1/4 ps-4 pe-1 mb-6 md:mb-0 mt-1 ml-auto me-2">
            <app-text-field [title]="'Balance Amount'" [type]="'number'" [disabled]="true"
              [value]="charge.balanceAmount.toString()" [(ngModel)]="charge.balanceAmount"></app-text-field>
          </div>
        </div>
      </div>
      <div class="w-full items-end flex flex-wrap justify-end -mx-3 mb-2">
        <button [disabled]="loading.resetting" type="button" (click)="resetClick()"
          [ngClass]="{'cursor-not-allowed':(loading.resetting)}"
          class="cursor-pointer text-white bg-gray-700 hover:bg-gray-800 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-xs px-3 py-2 me-2 mb-2 dark:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">
          <span *ngIf="!loading.resetting">Reset</span>
          <mat-spinner *ngIf="loading.resetting" [diameter]="16"></mat-spinner>
        </button>
        <button [disabled]="loading.submitting" type="button" (click)="submitClick()"
          [ngClass]="{'cursor-not-allowed':(loading.submitting)}"
          class="cursor-pointer text-white bg-gray-700 hover:bg-gray-800 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-xs px-3 py-2 me-2 mb-2 dark:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">
          <span *ngIf="!loading.submitting">Submit</span>
          <mat-spinner *ngIf="loading.submitting" [diameter]="16"></mat-spinner>
        </button>
      </div>
    </div>
  </mat-tab>
  <mat-tab [disabled]="patientDetailsLoaded === false" label="Package"> Package Content </mat-tab>
  <mat-tab label="Patients">
    @if(dataSource.data.length > 0) {

    <mat-form-field class="mt-2 px-2">
      <mat-label>Filter</mat-label>
      <input matInput (keyup)="applyFilter($event)" #input>
    </mat-form-field>

    <div class="mat-elevation-z8 px-2">
      <table mat-table [dataSource]="dataSource" matSort>

        <!-- OPID Column -->
        <ng-container matColumnDef="opid">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> OPID </th>
          <td mat-cell *matCellDef="let row"> <a class="text-blue-800 cursor-pointer"
              (click)="loadPatientsDetails(row.opid)">{{row.opid}}</a> </td>
        </ng-container>

        <!-- UHID Column -->
        <ng-container matColumnDef="uhid">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> UHID </th>
          <td mat-cell *matCellDef="let row"> {{row.uhid}} </td>
        </ng-container>

        <!-- Patients Name Column -->
        <ng-container matColumnDef="patientsName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Patients Name </th>
          <td mat-cell *matCellDef="let row"> {{row.patientsName}} </td>
        </ng-container>


        <!-- Company Name Column -->
        <ng-container matColumnDef="companyName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Company Name </th>
          <td mat-cell *matCellDef="let row"> {{row.companyName}} </td>
        </ng-container>

        <!-- Company Name Column -->
        <ng-container matColumnDef="admissionDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Admission Date </th>
          <td mat-cell *matCellDef="let row"> {{row.admissionDate}} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- Row shown when there is no matching data. -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="4">No data matching the filter "{{input.value}}"</td>
        </tr>
      </table>

      <!-- <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of patients"></mat-paginator> -->
    </div>
    }
    @else if(dataLoaded === false) {
    <mat-spinner class="ms-6" [diameter]="32" />
    }
  </mat-tab>
</mat-tab-group>